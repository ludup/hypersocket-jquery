<div id="contentAccessControl">
	<ul id="accessControlTabs">
		<li><a href="#tabUsers"><span localize="label.users"></span></a></li>
		<li><a href="#tabGroups"><span localize="label.groups"></span></a></li>
		<li><a href="#tabRoles"><span localize="label.roles"></span></a></li>
	</ul>
	<div id="tabUsers">
	</div>
	<div id="tabGroups">
	</div>
	<div id="tabRoles">
	</div>
	<div id="addRoleForm" class="dialog" dialog-for="tabRoles">
		<form class="form">
			<div id="roleDialogError" class="dialogError"></div>
			<div class="formInputField">
				<label for="name"
					class="formLabel" localize="role.name"></label> <input type="text"
					name="name" id="name"
					class="formInput text ui-widget-content ui-corner-all" />
			</div>
			<div id="roleProperties" class="tabContent">
				<ul id="rolePropertiesTabs">
					<li><a href="#tabRoleUsers"><span localize="label.users"></span></a></li>
					<li><a href="#tabRoleGroups"><span localize="label.groups"></span></a></li>
					<li><a href="#tabRolePermissions"><span localize="label.permissions"></span></a></li>
				</ul>
				<div id="tabRoleUsers"></div>
				<div id="tabRoleGroups"></div>
				<div id="tabRolePermissions"></div>
			</div>
			<input type="hidden" name="roleId" id="roleId"/>
		</form>
	</div>
	<div id="addGroupForm" class="dialog" dialog-for="tabGroups">
		<form class="form">
			<div id="groupDialogError" class="dialogError"></div>
			<div class="formInputField">
				 <label for="name"
					class="formLabel" localize="group.name"></label> <input type="text"
					name="name" id="groupName"
					class="formInput text ui-widget-content ui-corner-all" />
			</div>
			<div id="groupProperties" class="tabContent">
				<ul id="groupPropertiesTabs">
					<li><a href="#tabGroupUsers"><span localize="label.users"></span></a></li>
				</ul>
				<div id="tabGroupUsers" class="tabContent"></div>
			</div>
			<input type="hidden" name="groupId" id="groupId"/>
		</form>
	</div>
	<div id="addUserForm" class="dialog" dialog-for="tabUsers">
		<form class="form">
			<div id="userDialogError" class="dialogError"></div>
			<div class="formInputField">
				<label for="name"
					class="formLabel" localize="user.name"></label> <input type="text"
					name="name" id="userName"
					class="formInput text ui-widget-content ui-corner-all" />
			</div>
			<div id="userProperties" class="tabContent">
			</div>
			<div id="tabUserGroups" class="tabContent">
			</div>
			<input type="hidden" name="userId" id="userId"/>
		</form>
	</div>
	<div id="setPasswordForm" class="dialog">
		<form class="form">
			<div id="setPasswordDialogError" class="dialogError"></div>
			<div class="formInputField">
				<label for="password"
					class="formLabel" localize="label.password"></label> <input type="password"
					name="password" id="password"
					class="formInput text ui-widget-content ui-corner-all" />
			</div>
			<div class="formInputField">
				<label for="confirmPassword"
					class="formLabel" localize="label.confirmPassword"></label> <input type="password"
					name="confirmPassword" id="confirmPassword"
					class="formInput text ui-widget-content ui-corner-all" />
			</div>
			<div class="formInputField">
				<label for="name"
					class="formLabel" localize="label.forceChange"></label> <input type="checkbox"
					name="forceChange" id="forceChange"
					class="formInput text ui-widget-content ui-corner-all" />
			</div>
		</form>
	</div>
</div>
<script type="text/javascript">

	$(document).ready(function() {
		$('#contentAccessControl').localize();
		$('#contentAccessControl').tabs();
		
		getJSON('permissions', null, function(data) {
			$('#tabRolePermissions').multipleSelect({
				resourceKey: "permissions",
				values : data.permissions,
				nameAttrIsResourceKey : true,
				nameAttr : 'resourceKey',
				isPropertyInput: false,
				selectedIsObjectList: true
			});
		});
		

		getJSON('groups',
			null,
			function(data) {
				$('#tabRoleGroups').multipleSelect({
					resourceKey: "groups",
					values : data.resources,
					nameAttr : 'principalName',
					isPropertyInput: false,
					selectedIsObjectList: true
				});
				$('#tabUserGroups').multipleSelect({
					resourceKey: "groups",
					values : data.resources,
					nameAttr : 'principalName',
					isPropertyInput: false,
					selectedIsObjectList: true
				});
		});

		getJSON(
			'users',
			null,
			function(data) {
				
				$('#tabRoleUsers').multipleSelect({
					resourceKey: "users",
					values : data.resources,
					nameAttr : 'principalName',
					isPropertyInput: false,
					selectedIsObjectList: true
				});
				$('#tabGroupUsers').multipleSelect({
					resourceKey: "users",
					values : data.resources,
					nameAttr : 'principalName',
					isPropertyInput: false,
					selectedIsObjectList: true
				});
		});
		
		$('#userProperties').propertyPage({ url: 'template/user/local', showButtons: false, useTemplates: true, canUpdate: currentMenu.canUpdate,
	 		additionalTabs: [{ id: "tabUserGroups", name: getResource("label.groups") }]});

		$('#roleProperties').tabs();
		$('#groupProperties').tabs();
		$('#userProperties').tabs();
		
		$('#tabUsers').ajaxResourcePage(
					{
					tableUrl : "table/users",
					resourceUrl : "user",
					fields : [ { name: "principalName"}, 
					           { name: "principalDesc"} ],
					resourceKey : 'user',
					canCreate: currentMenu.canCreate,
					canUpdate: currentMenu.canUpdate,
					canDelete: currentMenu.canDelete,
					additionalActions : [ { resourceKey: "setPassword",
						iconClass: "ui-icon-locked",
						action : function(resource) {
							$('#setPasswordForm').data('resource', resource);
							$('#setPasswordForm').resourceDialog('create');
						},
						enabled: currentMenu.canUpdate}],
					validate : function() {
						if ($('#userName').val() == '') {
							$('#userDialogError').dialogError(
									"error.nameRequired");
							return false;
						}
						return true;
					},
					clearDialog : function() {
						$('#userName').val('');
						$('#userId').val('');
						$('#userProperties').clearProperties();
						$('#tabUserGroups').multipleSelect();
					},
					createResource : function() {
						user = new Object();
						user.id = $('#userId').val();
						user.name = $('#userName').val();
						
						$('#userProperties').saveProperties(true, function(items) {
							user.properties = items;
						});
						user.groups = $('#tabUserGroups')
								.multipleSelectValues();
						return user;
					},
					resourceCreated: function(resource) {
						$('#tabRoleUsers').multipleSelect( { insert: [ resource ] });
						$('#tabGroupUsers').multipleSelect( { insert: [ resource ] });
					},
					deleted : function(resource) {
						$('#tabRoleUsers').multipleSelect( { remove: [ resource ] });
						$('#tabGroupUsers').multipleSelect( { remove: [ resource ] });
					},
					displayResource : function(resource) {
						
						$('#userName').val(resource.name);
						$('#userId').val(resource.id);
	 	 			 	$('#userProperties').propertyPage({ url: 'user/properties/' + resource.id, showButtons: false, 
	 	 			 		canUpdate: currentMenu.canUpdate,
	 	 			 		additionalTabs: [{ id: "tabUserGroups", name: getResource("label.groups") }]});
	 	 			 	
	 	 			  	$('#tabUserGroups').multipleSelect({
	 						selected : resource.groups
	 					});
	 					
					}
				});
		
		$('#tabGroups').ajaxResourcePage(
				{
				tableUrl : "table/groups",
				resourceUrl : "group",
				fields : [ { name: "name"} ],
				resourceKey : 'group',
				canCreate: currentMenu.canCreate,
				canUpdate: currentMenu.canUpdate,
				canDelete: currentMenu.canDelete,
				validate : function() {
					if ($('#groupName').val() == '') {
						$('#groupDialogError').dialogError(
								"error.nameRequired");
						return false;
					}
					return true;
				},
				clearDialog : function() {
					$('#groupName').val('');
					$('#groupId').val('');
					$('#tabGroupUsers').multipleSelect();
				},
				createResource : function() {
					group = new Object();
					group.id = $('#groupId').val();
					group.name = $('#groupName').val();
					group.users = $('#tabGroupUsers')
							.multipleSelectValues();
					return group;
				},
				resourceCreated : function(resource) {
					$('#tabRoleGroups').multipleSelect( { insert: [ resource ] });
					$('#tabUserGroups').multipleSelect( { insert: [ resource ] });
				},
				deleted : function(resource) {
					$('#tabRoleGroups').multipleSelect( { remove: [ resource ] });
					$('#tabUserGroups').multipleSelect( { remove: [ resource ] });
				},
				displayResource : function(resource) {
					$('#groupId').val(resource.id);
					$('#groupName').val(resource.name);
					getJSON("users/" + resource.id, null, function(data) {
						$('#tabGroupUsers').multipleSelect({
	 						selected : data.resources
	 					});
					});
 	 			  	
				}
			});
		
		
		$('#tabRoles').resourcePage(
				{
				tableUrl : "roles",
				resourceUrl : "role",
				fields : [ { name: "name"} ],
				resourceKey : 'role',
				canCreate: currentMenu.canCreate,
				canUpdate: currentMenu.canUpdate,
				canDelete: currentMenu.canDelete,
				validate : function() {
					if ($('#name').val() == '') {
						$('#roleDialogError').dialogError(
								"error.nameRequired");
						return false;
					}
					return true;
				},
				clearDialog : function() {
					$('#name').val('');
					$('#roleId').val('');
					$('#tabRoleUsers').multipleSelect();
					$('#tabRoleGroups').multipleSelect();
					$('#tabRolePermissions').multipleSelect();

				},
				createResource : function() {
					role = new Object();
					role.id = $('#roleId').val();
					role.name = $('#name').val();
					role.users = $('#tabRoleUsers')
							.multipleSelectValues();
					role.groups = $('#tabRoleGroups')
							.multipleSelectValues();
					role.permissions = $('#tabRolePermissions')
							.multipleSelectValues();
					return role;
				},
				resourceCreated : function(resource) {
					
				},
				deleted : function(resource) {
					
				},
				displayResource : function(resource) {
					$('#roleId').val(resource.id);
					$('#name').val(resource.name);
 	 			  	$('#tabRoleUsers').multipleSelect({
 						selected : resource.principals
 					});
 					$('#tabRoleGroups').multipleSelect({
 						selected : resource.principals
 					});
 					$('#tabRolePermissions').multipleSelect({
 						selected : resource.permissions
 					});
				},
				complete: function() {
					loadComplete();
				}
			});
		
		$('#setPasswordForm').resourceDialog({ resourceKey: 'setPassword',
			resourceUrl: 'credentials',
			hasResourceTable: false,
			createResource: function() {
				
				var resource = $('#setPasswordForm').data('resource');
				
				creds = new Object();
				creds.principalId = resource.id;
				creds.password = $('#password').val();
				creds.forceChange = $('#forceChange').attr('checked') ? true : false;
				
				return creds;
			},
			clearDialog: function() {
				 $('#password').val('');
				 $('#confirmPassword').val('');
				 $('#forceChange').val('');
			},
			validate: function() {
				if($('#password').val()=='') {
					$('#setPasswordDialogError').dialogError("error.passwordEmpty");
					return false;
				}
				if($('#password').val()!=$('#confirmPassword').val()) {
					$('#setPasswordDialogError').dialogError("error.passwordsNotMatched");
					return false;
				}
				return true;
			}});
	});
	

	
</script>