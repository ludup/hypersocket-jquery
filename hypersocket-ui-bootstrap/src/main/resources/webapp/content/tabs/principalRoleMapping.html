<div data-id="principalRoleMapping" class="extendedTabContent">
    <div data-id="rolesTab"></div>
    <div class="row10 help-block">
        <span localize="principal.role.mapping.info"></span>
    </div>
</div>
<script>

$(document).ready(function() {
    $('.extendedTabContent').data('initPage', function(resource, data, readonly) {
        var _$ = function(jq) { return $(jq + '_' + resource.id);}
        var el = _$('#rolesTab');

        _$('#principalRoleMapping').localize();

       
            getJSON('currentRealm/user/' + resource.id + '/roles', null, function(response){
                if(response.resources) {
                    var initObj = {
                        disabled: readonly,
                        nameAttr : 'name',
                        selectedIsObjectList: false,
                        valueAttr: 'id',
                        selected: response.resources,
                        confirmRemove: true,
                        addOnSelect: false,
                        preAddCallback : function(data){
                       
                             var roleId = data.id;
                             patchJSON('roles/' + roleId + '/user/' + resource.id, null, function(data){
                                 if(data.success){
                                     showSuccess(data.message);
                                 }else{
                                     showError(data.message);
                                 }
                             });
                             return true;
   
                        },
                        preRemoveCallback : function(evt) {
                            
                                var callback = el.data('widget');
                                var roleId = $(evt.target).data('value').id;
                                deleteJSON('roles/' + roleId + '/user/' + resource.id, null, function(response){
                                    if(response.success){
                                        showSuccess(response.message);
                                    }else{
                                        showError(response.message);
                                        el.multipleSearchInput(initObj);
                                    }
                                });
                                return true;
                           
                        },
                        objectDeletable : function(obj){
                            return !obj.allUsers;
                        },
                        url : 'roles/filter/user/' + resource.id
                    };
                    el.multipleSearchInput(initObj);
                }
            });
       
    });
});
</script>