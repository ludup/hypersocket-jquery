<!-- 
	Replace any Trigger or Triggers with Capitalized name of your resources e.g. Application or Applications
	Replace any trigger or triggers with lower case name of your resources e.g. application or applications
 -->

<div id="contentTriggers">
</div>
<div id="contentTrigger" class="panel panel-default" style="display: none;">

		<div class="spacer20px"></div>
		<div class="row">
			<div class="col-md-9" id="schemeArea">
				<div id="triggerTasks" style="overflow: auto; height: 800px">
					<div id="rootTrigger" class="moduleShape same-row">
						<span id="triggerEvent" class="moduleText"></span>
					</div>
					<div id="triggerView" class="same-row"></div>
				</div>
				<div class="spacer20px"></div>
			</div>
			<div class="col-md-3" id="moduleArea">
				<div id="moduleIcons"></div>
			</div>
		</div>
</div>
<!-- <div id="drawing" style="height: 1000px"></div> -->
<script type="text/javascript">
	var resourceList = [];
	$(document).ready(function() {
				$('#contentTriggers').localize();
				$('#contentTrigger').localize();
				$('#saveTriggerbutton').attr('disabled', true);
				$('#contentTriggers').load('content/triggers-modal.html', function() {
						
					var resourcePage = $('#contentTriggers').ajaxResourcePage(
							{
								id : "Trigger",
								tableUrl : "triggers/table",
								title: getResource("triggers.label"),
								icon: 'fa-globe',
								resourceUrl : "triggers/trigger",
								fields : [ {
									name : "name"
								}],
								resourceKey : "trigger",
								canCreate: currentMenu.canCreate,
								canUpdate: currentMenu.canUpdate,
								canDelete: currentMenu.canDelete,
								showCreate: function() {
									$(document).data('triggerModalCallback').loadParent(null, null);
								},
								showUpdate: function() {
									$(document).data('triggerModalCallback').loadParent(null, null);
								},
								validate : function() {
									return $(document).data('triggerModalCallback').validate();
								},
								clearDialog : function(create) {
									$(document).data('triggerModalCallback').clearDialog(create);
								},
								createResource : function() {
									return $(document).data('triggerModalCallback').createResource();
								},
								displayResource : function(resource) {
									$(document).data('triggerModalCallback').loadParent(null, null);
									$(document).data('triggerModalCallback').displayResource(resource);
								},
								complete : function() {
									loadComplete();
								},
								resourceUpdated: function() {
									$('#triggerView').empty();
									$('._jsPlumb_connector').remove();
									resourceTable.refresh();
								},
								selected: function(row) {

									$('#triggerView').empty();
									$('._jsPlumb_connector').remove();
									resourceList = [];
									if(row) {
										$('#contentTrigger').show();
										$('#triggerEvent').text(getResource(row.event));
										$('#triggerName').text(row.name);
										
 										$('#triggerName').prepend('<span class="label ' + getStateLabelClass(row) + '">' + getResource(getStateLabelText(row)) + '</span>&nbsp;&nbsp;&nbsp;');

					                	var trigger = row;
					                	var top = 25;
					                	var left = 200;
					                	addTask(trigger, null, top+50, left+50);
					                	
					                	jsPlumb.connect({
					        	            source: 'rootTrigger',
					        	            target:"trigger" + trigger.id,
					        	            connector: 'Straight',
					        	            anchor: "AutoDefault",
					        	            endpoint:"Blank",
					        	            detachable:false,
					        	            overlays:["PlainArrow"]
					        	        });	
					                	
										jsPlumb.draggable($('.moduleShape'));
										
										$('.moduleShape').draggable({
									        stop: function(e){
									            
									            state = new Object();
									            state.top = $(this).css('top').substring(0, $(this).css('top').length - 2);
									            state.leftpx = $(this).css('left').substring(0, $(this).css('left').length - 2);
									            state.resourceId = $(this).data('trigger').id;
									            debugger;
									            /*postJSON('interfaceState/state', state, function(data){
									            	debugger;
									            });*/
									        }
									    });
										
										$('.addIcon').off('click');
										$('.addIcon').on('click', function(e) {
											e.preventDefault();
											var trigger = $(this).closest('.moduleShape').data('trigger');
											
											getJSON('triggers/parentEvents/' + trigger.id, null, function(data) {
												$(document).data('triggerModalCallback').loadParent(trigger, data.resources);
												$('div[dialog-for="contentTriggers"]').resourceDialog('create');
											});
										});
										
										$('.editIcon').off('click');
										$('.editIcon').on('click', function(e) {
											e.preventDefault();
											var trigger = $(this).closest('.moduleShape').data('trigger');
												$('div[dialog-for="contentTriggers"]').resourceDialog('edit', { resource: trigger});
										});
										
										$('.deleteIcon').off('click');
										$('.deleteIcon').on('click', function(e) {
											e.preventDefault();
											var trigger = $(this).closest('.moduleShape').data('trigger');
											if(!trigger.isRoot) {
												bootbox.confirm(getResource("confirm.deleteTriggerItem").format(trigger.name), function(result) {
													  if(result) {
														  deleteJSON('triggers/trigger/' + trigger.id, null, function(data) {
																if(data.success) {
																	showSuccess(data.message);
																	$('#triggerView').empty();
																	$('._jsPlumb_connector').remove();
																	resourcePage.refresh();
																} else {
																	showError(data.message)
																}
															});
													  }
												}); 
											} else {
												bootbox.confirm(getResource("confirm.deleteTrigger").format(trigger.name), function(result) {
													  if(result) {
														  deleteJSON('triggers/trigger/' + trigger.id, null, function(data) {
																if(data.success) {
																	showSuccess(data.message);
																	$('#triggerView').empty();
																	$('._jsPlumb_connector').remove();
																	resourcePage.refresh();
																} else {
																	showError(data.message)
																}
															});
													  }
												}); 
											}
											
										});
										
										
										
									} else {
										$('#contentTrigger').hide();
									}
									debugger;
									getJSON('interfaceState/state/' + resourceList, null, function(data){
										debugger;
										if(data.success){
											$.each(data.resources, function(index, value){
												$('#trigger' + value.resourceId).css('top', value.top + 'px');
												$('#trigger' + value.resourceId).css('leftpx', value.leftpx + 'px');
											});
										}
									});
								}
							});
				});

			});
	
	function getStateLabelClass(trigger) {
		var moduleClass = "label-info";
		if(trigger.result == 'EVENT_FAILURE') {
			moduleClass = "label-danger";
		}else if(trigger.result == 'EVENT_WARNING') {
			moduleClass = "label-warning";
		} else if(trigger.result == 'EVENT_SUCCESS') {
			moduleClass = "label-success";
		}
		
		return moduleClass;
	}
	
	function getStateLabelText(trigger) {
		var moduleClass = "text.any";
		if(trigger.result == 'EVENT_FAILURE') {
			moduleClass = "text.failure";
		}else if(trigger.result == 'EVENT_WARNING') {
			moduleClass = "text.warning";
		} else if(trigger.result == 'EVENT_SUCCESS') {
			moduleClass = "text.success";
		}
		
		return moduleClass;
	}
	
	function getStateClass(trigger) {
		
		var moduleClass = "trigger-any";
		if(trigger.result == 'EVENT_FAILURE') {
			moduleClass = "trigger-failure";
		}else if(trigger.result == 'EVENT_WARNING') {
			moduleClass = "trigger-warning";
		} else if(trigger.result == 'EVENT_SUCCESS') {
			moduleClass = "trigger-success";
		}
		
		return moduleClass;
	}
	
	function addTask(trigger, parent, top, left) {
		resourceList.push(trigger.id);
		var moduleClass = "blueModule";
		if(trigger.result == 'EVENT_FAILURE') {
			moduleClass = "redModule";
		}else if(trigger.result == 'EVENT_WARNING') {
			moduleClass = "yellowModule";
		} else if(trigger.result == 'EVENT_SUCCESS') {
			moduleClass = "greenModule";
		}
		
		$('#triggerView').append("<div style='top: " + top + "px; left: " + left + "px; position: absolute;' class='moduleShape " 
				+ moduleClass + " same-row' id='trigger" + trigger.id + "'><div><a data-trigger='"
				+ trigger.id + "' class='addIcon' href=''><i class='fa fa-plus-circle'></i></a><a data-trigger='" 
				+ trigger.id + "' class='editIcon' href=''><i class='fa fa-edit'></i></a><a data-trigger='" 
				+ trigger.id + "' class='deleteIcon' href=''><i class='fa fa-trash-o'></i></a></div><span class='moduleText'>"
				+ trigger.name + "</span></div>");
		
		$('#trigger' + trigger.id).data('trigger', trigger);
		
		if(parent) {
			jsPlumb.connect({
	            source:"trigger" + parent.id,
	            target:"trigger" + trigger.id,
	            connector: 'Straight',
	            anchor: "AutoDefault",
	            endpoint:"Blank",
	            detachable:false,
	            overlays:["Arrow"],
	        });	
		}
		
		top+= 50;
		$.each(trigger.childTriggers, function(idx, childTrigger) {
			left+=175;
			addTask(childTrigger, trigger, top, left);
		});
        
        
	}
</script>