<!-- 
	Replace any Trigger or Triggers with Capitalized name of your resources e.g. Application or Applications
	Replace any trigger or triggers with lower case name of your resources e.g. application or applications
 -->

<div id="contentTriggers">
</div>
<div id="contentTrigger" class="panel panel-default" style="display: none;">

		<div class="spacer20px"></div>
		<div class="row">
			<div class="col-md-9" id="schemeArea">
				<div id="triggerTasks" style="overflow: auto; height: 800px">
					<div id="rootTrigger" class="triggerShape trigger-same-row">
						<span id="triggerEvent" class="triggerContent"></span>
					</div>
					<div id="triggerView" class="trigger-same-row"></div>
				</div>
				<div class="spacer20px"></div>
			</div>
			<div class="col-md-3" id="triggerArea">
				<div id="triggerIcons"></div>
			</div>
		</div>
</div>
<!-- <div id="drawing" style="height: 1000px"></div> -->
<script type="text/javascript">
	var triggerList = [];
	var resourceList = [];
	$(document).ready(function() {
				$('#contentTriggers').localize();
				$('#contentTrigger').localize();
				$('#saveTriggerbutton').attr('disabled', true);
				$('#contentTriggers').load('content/triggers-modal.html', function() {
						
					var resourcePage = $('#contentTriggers').ajaxResourcePage(
							{
								id : "Trigger",
								tableUrl : "triggers/table",
								title: getResource("triggers.label"),
								icon: 'fa-globe',
								resourceUrl : "triggers/trigger",
								fields : [ {
									name : "name"
								}],
								resourceKey : "trigger",
								canCreate: currentMenu.canCreate,
								canUpdate: currentMenu.canUpdate,
								canDelete: currentMenu.canDelete,
								showCreate: function() {
									$(document).data('triggerModalCallback').loadParent(null, null);
								},
								showUpdate: function() {
									$(document).data('triggerModalCallback').loadParent(null, null);
								},
								validate : function() {
									return $(document).data('triggerModalCallback').validate();
								},
								clearDialog : function(create) {
									$(document).data('triggerModalCallback').clearDialog(create);
								},
								createResource : function() {
									return $(document).data('triggerModalCallback').createResource();
								},
								displayResource : function(resource) {
									$(document).data('triggerModalCallback').loadParent(null, null);
									$(document).data('triggerModalCallback').displayResource(resource);
								},
								complete : function() {
									loadComplete();
								},
								resourceUpdated: function() {
									$('#triggerView').empty();
									$('._jsPlumb_connector').remove();
									resourceTable.refresh();
								},
								selected: function(row) {

									$('#triggerView').empty();
									$('._jsPlumb_connector').remove();
									triggerList = [];
									
									if(row) {
										$('#contentTrigger').show();
										$('#triggerEvent').text(getResource(row.event));
										$('#triggerName').text(row.name);
										
 										$('#triggerName').prepend('<span class="label ' + getStateLabelClass(row) + '">' + getResource(getStateLabelText(row)) + '</span>&nbsp;&nbsp;&nbsp;');

					                	var trigger = row;
					                	triggerList.push(trigger.id);
					                	createTriggerList(trigger.childTriggers);
					                	var top = 25;
					                	var left = 200;
					                	getJSON('interfaceState/state/false/' + triggerList, null, function(data){
					                		resourceList = data.resources;
					                		addTask(trigger, null, top+50, left+50);
						                	jsPlumb.connect({
						        	            source: 'rootTrigger',
						        	            target:"trigger" + trigger.id,
						        	            connector: 'Straight',
						        	            anchor: "AutoDefault",
						        	            endpoint:"Blank",
						        	            detachable:false,
						        	            overlays:[["Arrow", {location: 1}]]
						        	        });
						                	
											jsPlumb.draggable($('.triggerShape'));
											
											$('.triggerShape').draggable({
										        stop: function(e){
										            if($(this).data('trigger')){
										            	state = new Object();
											            state.top = Math.round($(this).css('top').substring(0, $(this).css('top').length - 2));
											            state.leftpx = Math.round($(this).css('left').substring(0, $(this).css('left').length - 2));
											            state.resourceId = $(this).data('trigger').id;
											            state.name = $(this).attr('id');
											            state.specific = false;
											            postJSON('interfaceState/state', state, function(data){
											            	
											            });
										            }
										        }
										    });
											
											$('.addIcon').off('click');
											$('.addIcon').on('click', function(e) {
												e.preventDefault();
												var trigger = $(this).closest('.triggerShape').data('trigger');
												
												getJSON('triggers/parentEvents/' + trigger.id, null, function(data) {
													$(document).data('triggerModalCallback').loadParent(trigger, data.resources);
													$('div[dialog-for="contentTriggers"]').resourceDialog('create');
												});
											});
											
											$('.editIcon').off('click');
											$('.editIcon').on('click', function(e) {
												e.preventDefault();
												var trigger = $(this).closest('.triggerShape').data('trigger');
													$('div[dialog-for="contentTriggers"]').resourceDialog('edit', { resource: trigger});
											});
											
											$('.deleteTriggerIcon').off('click');
											$('.deleteTriggerIcon').on('click', function(e) {
												e.preventDefault();
												var trigger = $(this).closest('.triggerShape').data('trigger');
												if(!trigger.isRoot) {
													bootbox.confirm(getResource("confirm.deleteTriggerItem").format(trigger.name), function(result) {
														  if(result) {
															  deleteJSON('triggers/trigger/' + trigger.id, null, function(data) {
																	if(data.success) {
																		showSuccess(data.message);
																		$('#triggerView').empty();
																		$('._jsPlumb_connector').remove();
																		resourcePage.refresh();
																	} else {
																		showError(data.message)
																	}
																});
														  }
													}); 
												} else {
													bootbox.confirm(getResource("confirm.deleteTrigger").format(trigger.name), function(result) {
														  if(result) {
															  deleteJSON('triggers/trigger/' + trigger.id, null, function(data) {
																	if(data.success) {
																		showSuccess(data.message);
																		$('#triggerView').empty();
																		$('._jsPlumb_connector').remove();
																		resourcePage.refresh();
																	} else {
																		showError(data.message)
																	}
																});
														  }
													}); 
												}
												
											});
					                	});
					                	
										
										
										
									} else {
										$('#contentTrigger').hide();
									}
								}
							});
				});

			});
	
	function getStateLabelClass(trigger) {
		var triggerClass = "label-info";
		if(trigger.result == 'EVENT_FAILURE') {
			triggerClass = "label-danger";
		}else if(trigger.result == 'EVENT_WARNING') {
			triggerClass = "label-warning";
		} else if(trigger.result == 'EVENT_SUCCESS') {
			triggerClass = "label-success";
		}
		
		return triggerClass;
	}
	
	function getStateLabelText(trigger) {
		var triggerText = "text.any";
		if(trigger.result == 'EVENT_FAILURE') {
			triggerText = "text.failure";
		}else if(trigger.result == 'EVENT_WARNING') {
			triggerText = "text.warning";
		} else if(trigger.result == 'EVENT_SUCCESS') {
			triggerText = "text.success";
		}
		
		return triggerText;
	}
	
	function getStateClass(trigger) {
		
		var triggerClass = "trigger-any";
		if(trigger.result == 'EVENT_FAILURE') {
			triggerClass = "trigger-failure";
		}else if(trigger.result == 'EVENT_WARNING') {
			triggerClass = "trigger-warning";
		} else if(trigger.result == 'EVENT_SUCCESS') {
			triggerClass = "trigger-success";
		}
		
		return triggerClass;
	}
	
	function createTriggerList(childTriggers){
		$.each(childTriggers, function(index, triggerValue){
			triggerList.push(triggerValue.id);
			if(triggerValue.childTriggers && triggerValue.childTriggers.length){
				createTriggerList(triggerValue.childTriggers);
			}
		});
	}
	
	function addTask(trigger, parent, top, left) {
		var triggerClass = "blueTrigger";
		if(trigger.result == 'EVENT_FAILURE') {
			triggerClass = "redTrigger";
		}else if(trigger.result == 'EVENT_WARNING') {
			triggerClass = "yellowTrigger";
		} else if(trigger.result == 'EVENT_SUCCESS') {
			triggerClass = "greenTrigger";
		}
		$.each(resourceList, function(index, value){
			if(value.resourceId == trigger.id){
				top = value.top;
				left = value.leftpx;
				return false;
			}
		});
		$('#triggerView').append(
					"<div style='top: " + top + "px; left: " + left + "px; position: absolute;' class='triggerShape " + triggerClass + " trigger-same-row' id='trigger" + trigger.id + "'>"
				+	"	<div class='triggerContent'>"
				+	"		<span class='triggerText'>"	+ trigger.name + "</span>"
				+	"		<a data-trigger='"+ trigger.id + "' class='addIcon triggerIcon' href=''>"
				+	"			<i class='fa fa-plus-circle'></i>"
				+	"		</a>"
				+	"		<a data-trigger='" + trigger.id + "' class='editIcon triggerIcon' href=''>"
				+	"			<i class='fa fa-edit'></i>"
				+	"		</a>"
				+	"		<a data-trigger='" + trigger.id + "' class='deleteTriggerIcon triggerIcon' href=''>"
				+	"			<i class='fa fa-trash-o'></i>"
				+	"		</a>"
				+	"	</div>"
				+	"</div>");
		
		$('#trigger' + trigger.id).data('trigger', trigger);
		$('#trigger' + trigger.id).data('parent', parent);
		
		if(parent) {
			jsPlumb.connect({
	            source:"trigger" + parent.id,
	            target:"trigger" + trigger.id,
	            connector: 'Straight',
	            anchor: "AutoDefault",
	            endpoint:"Blank",
	            detachable:false,
	            overlays:[["Arrow", {location: 1}]]
	        });	
		}
		
		top+= 50;
		$.each(trigger.childTriggers, function(idx, childTrigger) {
			left+=175;
			addTask(childTrigger, trigger, top, left);
		});
        
        
	}
</script>
<script src="${uiPath}/js/jquery.jsPlumb-1.7.5.min.js"></script>