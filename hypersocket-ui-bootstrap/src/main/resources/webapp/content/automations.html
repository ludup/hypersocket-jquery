<!-- 
	Replace any Automation or Automations with Capitalized name of your resources e.g. Application or Applications
	Replace any automation or automations with lower case name of your resources e.g. application or applications
 -->

<div id="contentAutomations">
	<div class="modal" id="addAutomationForm" tabindex="-1" role="dialog" dialog-for="contentAutomations">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-hidden="true">&times;</button>
					<h4 class="modal-title"></h4>
				</div>
				<div class="modal-body">
					<div class="propertyItem form-group">
						<label class="col-xs-3 control-label" localize="automation.name.label"></label>
						<div class="propertyValue col-xs-9">
							<input type="text" class="form-control"
								placeholder="" id="resourceName" maxlength="" name="resourceName" value="">
							<div>
								<span class="help-block" localize="automation.name.info"></span>
							</div>
						</div>
					</div>
					<div class="propertyItem form-group">
						<label class="col-xs-3 control-label" localize="automation.task.label"></label>
						<div id="typeButton" class="propertyValue col-xs-9"></div>
					</div>
					<div id="automationProperties"></div>
					<input type="hidden" id="resourceId" name="resourceId" value="" />
				</div>
				<div class="modal-footer"></div>
			</div>
		</div>
	</div>
</div>
<div id="contentTriggers"></div>
<!-- <div id="contentTrigger" class="panel panel-default" style="display: none;"> -->

<!-- 		<div class="spacer20px"></div> -->
<!-- 		<div class="row"> -->
<!-- 			<div class="col-md-9" id="schemeArea"> -->
<!-- 				<div id="triggerTasks" style="overflow: auto; height: 800px"> -->
<!-- 					<div id="rootTrigger"> -->
<!-- 					</div> -->
<!-- 					<div id="triggerView" class="trigger-same-row"></div> -->
<!-- 				</div> -->
<!-- 				<div class="spacer20px"></div> -->
<!-- 			</div> -->
<!-- 			<div class="col-md-3" id="triggerArea"> -->
<!-- 				<div id="triggerIcons"></div> -->
<!-- 			</div> -->
<!-- 		</div> -->
<!-- </div> -->
<script type="text/javascript">
	$(document).ready(function() {
		
		$('#contentTriggers').load(uiPath + '/content/triggers-modal.html', function() {
				$('#contentAutomations').localize();
				
				var displaying = false;
				var typeButton = $('#typeButton').autoComplete({
					url: 'automations/tasks',
					nameIsResourceKey: true,
					resourceKeyTemplate: '{0}.label',
					getUrlData: function(data) {
						return data.resources;
					},
					changed: function(widget) {
						$('#automationProperties').empty();
						if(widget.getObject() && widget.getObject().value != '') {
							if(!displaying) {
								
								var o  =widget.getObject();
								$('#automationProperties').propertyPage({ 
									url : 'automations/template/' +  widget.getObject().name + '/', 
									showButtons : false, 
									i18nNamespace: 'automations',
									useFilters: true,
									canUpdate : currentMenu.canUpdate, 
									useTemplates : true,
									propertyTabsLast: false
								});
							}
						}
					}
				});
			
				
				$('div[dialog-for="contentTriggers"]').resourceDialog({
					resourceKey: 'automation',
					resourceUrl : "automations/trigger",
					showCreate: function() {
// 						$(document).data('triggerModalCallback').loadParent(null, null, 1);
					},
					showUpdate: function() {
// 						$(document).data('triggerModalCallback').loadParent(null, null, 1);
					},
					validate : function() {
						return $(document).data('triggerModalCallback').validate();
					},
					clearDialog : function(create) {
						$(document).data('triggerModalCallback').clearDialog(create);
					},
					createResource : function() {
						return $(document).data('triggerModalCallback').createResource();
					},
					displayResource : function(resource) {
// 						$(document).data('triggerModalCallback').loadParent(null, null, 1);
						$(document).data('triggerModalCallback').displayResource(resource);
					}
				});

				var resourcePage = $('#contentAutomations').ajaxResourcePage(
						{
							id : "Automation",
							tableUrl : "automations/table",
							title: getResource("automations.label"),
							infoHtml: getResource('automations.infoHtml'),
							icon: 'fa-clock-o',
							resourceUrl : "automations/automation",
							deleteResourcesUrl : "automations/bulk",
							fields : [ {
								name : "name"
							}],
							resourceKey : "automation",
							canCreate: currentMenu.canCreate,
							canUpdate: currentMenu.canUpdate,
							canDelete: currentMenu.canDelete,
							checkbox : true,
							additionalActions: [{
								resourceKey : 'automationRunNow',
								iconClass : 'fa-play',
								action : function(resource, callback) {

									getJSON('automations/run/' + resource.id, null, function(data) {

									});
								},
								enabled : true
							}],
							validate : function() {
								if ($('#resourceName').val() == '') {
									showError("error.nameRequired");
									return false;
								}
								if(!$('#automationProperties').validateProperties()) {
									showError("error.correctValidationErrors");
									return false;
								}
								return true;
							},
							clearDialog : function(create) {
								
								$('#resourceId').val('');
								$('#resourceName').val('');
								typeButton.clear();			
								$('#automationProperties').empty();
								$('.tabPropertiesTab').first().trigger('click');
							},
							createResource : function() {
								resource = new Object();
								resource.id = $('#resourceId').val();
								resource.name = $('#resourceName').val();
								
								$('#automationProperties').saveProperties(true,
										function(items) {
											resource.properties = items;
								});
		
								resource.properties.push(new PropertyItem('resourceKey', typeButton.getValue()));
								
								return resource;
							},
							displayResource : function(resource, readOnly) {
								debugger;
								$('#resourceId').val(resource.id);
								$('#resourceName').val(resource.name);
								displaying = true;
								typeButton.setValue(resource.resourceKey, false);
								
								$('#automationProperties').empty();
								$('#automationProperties').propertyPage(
										{ url : 'automations/properties/' + resource.id, 
											showButtons : false, 
											i18nNamespace: 'automations',
											useFilters: true,
											canUpdate : currentMenu.canUpdate && !readOnly,
											propertyTabsLast: false
								});
								displaying = false;
							
							},
							complete : function() {
								loadComplete();
							},
// 							selected: function(row) {

// 								renderDiagram(row, resourcePage);
// 							}
							detailView: true,
							detailFormatter: function(index, resource, element) {
								// Here element is the jquery object where you can render the view and resource is the table rows resource.
								element.append(
										'<div id="contentTrigger' + resource.id + '" class="panel panel-default" style="display: none;">'
									+	'<div class="spacer20px"></div>'
									+	'	<div class="row">'
									+	'		<div class="col-md-12" id="schemeArea' + resource.id + '">'	
									+	'			<div id="triggerTasks' + resource.id + '" style="overflow: auto; height: 300px">'		
									+	'				<div id="rootTrigger' + resource.id + '" class="triggerShape trigger-same-row" style="position: absolute; left: 50px; top: 50px;">'			
									+	'					<span id="rootEvent' + resource.id + '" class="triggerContent"></span>'				
									+	'				</div>'			
									+	'			</div>'		
									+	'			<div class="spacer20px"></div>'		
									+	'		</div>'	
									+	'		<div class="col-md-3" id="triggerArea' + resource.id + '">'
									+	'			<div id="triggerIcons' + resource.id + '"></div>'				
									+	'		</div>'
									+	'	</div>'
									+	'</div>');
								
								var jsPlumbInstance = jsPlumb.getInstance();
								jsPlumbInstance.setContainer($('#schemeArea' + resource.id));
								renderDiagram(resource, resourcePage, resource.id, jsPlumbInstance);
							}
						});
		});

	});
	
	function renderDiagram(trigger, resourcePage, rootId, jsPlumbInstance) {
		//jsPlumb.empty($('#triggerView' + rootId));
		triggerList = [];
		triggerMap = [];
		if(trigger) {
			debugger;
			$('#contentTrigger' + trigger.id).show();
			$('#rootEvent' + trigger.id).text(getResource(trigger.resourceKey));

        	triggerList.push('triggerDiagram_' + trigger.id);
        	triggerMap[trigger.id] = trigger;
        	createTriggerList(trigger.childTriggers);
        	var top = 25;
        	var left = 200;
        	getState(triggerList, false, function(data){
        		resourceList = data.resources;
        		addTask(trigger, null, top+50, left+50, rootId, jsPlumbInstance);
        		jsPlumbInstance.connect({
    	            source: 'rootTrigger' + trigger.id,
    	            target:"triggerDiagram_" + trigger.id,
    	            connector: 'Flowchart',
    	            anchor: "AutoDefault",
    	            endpoint:"Blank",
    	            detachable:false,
    	            overlays:[["Arrow", {location: 1}]]
    	        });
				jsPlumbInstance.draggable($('#triggerDiagram_' + trigger.id));				
				$('#triggerDiagram_' + trigger.id).draggable({
			        stop: function(e){
			            if($(this).data('trigger')){
			            	var preferences = {};
			            	state = new Object();
			            	preferences.top = Math.round($(this).css('top').substring(0, $(this).css('top').length - 2));
			            	preferences.leftpx = Math.round($(this).css('left').substring(0, $(this).css('left').length - 2));
				            if(preferences.leftpx < 0) {
				            	preferences.leftpx = 0;
				            }
				            if(preferences.top < 0) {
				            	preferences.top = 0;
				            }
				            
				            saveState('triggerDiagram_' + $(this).data('trigger').id, preferences, false);
			            }
			        },
					containment: 'parent'
			    });
				
				$('.addIcon').off('click');
				$('.addIcon').on('click', function(e) {
					e.preventDefault();
					var trigger = $(this).closest('.triggerShape').data('trigger');
					getJSON('triggers/parentEvents/' + trigger.id, null, function(data) {
						$(document).data('triggerModalCallback').loadParent(trigger, data.resources, 0);
						$('#contentAutomations').data('callback').showCreate(
								function(resource) {
									renderDiagram(resource, resourcePage, rootId, jsPlumbInstance);
						});
// 						$('div[dialog-for="contentTriggers"]').resourceDialog('create', { 
// 							resourceCreated: function(resource) {
// 								renderDiagram(resource, resourcePage, rootId, jsPlumbInstance);
// 							}
// 						});
					});
				});
				
				$('.editIcon').off('click');
				$('.editIcon').on('click', function(e) {
					e.preventDefault();
					var triggerShape = $(this).closest('.triggerShape');
					debugger;
					var trigger = triggerShape.data('trigger');
// 					$('div[dialog-for="contentTriggers"]').resourceDialog('edit', trigger);
					$('#contentAutomations').data('callback').showEdit(trigger);
				});
				  
				$('.deleteTriggerIcon').off('click');
				$('.deleteTriggerIcon').on('click', function(e) {
					debugger;
					e.preventDefault();
					var triggerShape = $(this).closest('.triggerShape');
					var trigger = triggerShape.data('trigger');
					$('#contentAutomations').data('callback').deleteResource(trigger);
// 					if(!trigger.isRoot) {
// 						bootbox.confirm(getResource("confirm.deleteTriggerItem").format(trigger.name), function(result) {
// 							  if(result) {
// 								  deleteJSON('automations/automation/' + trigger.id, null, function(data) {
// 										if(data.success) {
// 											showSuccess(data.message);
// 											renderDiagram(data.resource, resourcePage, rootId, jsPlumbInstance);
// 											resourcePage.refresh();
// 										} else {
// 											showError(data.message)
// 										}
// 									});
// 							  }
// 						}); 
// 					} else {
// 						bootbox.confirm(getResource("confirm.deleteTrigger").format(trigger.name), function(result) {
// 							  if(result) {
// 								  deleteJSON('automations/automation/' + trigger.id, null, function(data) {
// 										if(data.success) {
// 											showSuccess(data.message);
// 											renderDiagram(null, resourcePage, rootId, jsPlumbInstance);
// 											resourcePage.refresh();
// 										} else {
// 											showError(data.message);
// 										}
// 									});
// 							  }
// 						}); 
// 					}
					
				});
        	});
        	
		} else {
			$('#contentTrigger' + trigger.id).hide();
		}
	}
	
	function createTriggerList(childTriggers){
		$.each(childTriggers, function(index, triggerValue){
			triggerList.push('triggerDiagram_' + triggerValue.id);
			triggerMap[triggerValue.id] = triggerValue;
			if(triggerValue.childTriggers && triggerValue.childTriggers.length){
				createTriggerList(triggerValue.childTriggers);
			}
		});
	}
	
	function addTask(trigger, parent, top, left, rootId, jsPlumbInstance) {
		debugger;
		var triggerClass = "blueTrigger";
		
		$.each(resourceList, function(index, value){
			var preferences = JSON.parse(value.preferences);
			if(value.name == 'triggerDiagram_' + trigger.id){
				top = preferences.top;
				left = preferences.leftpx;
				return false;
			}
		});
		
		$('#triggerTasks' + rootId).append(
					"<div style='top: " + top + "px; left: " + left + "px; position: absolute;' class='triggerShape triggerDraggable blueTrigger trigger-same-row' id='triggerDiagram_" + trigger.id + "'>"
				+	"	<div class='triggerContent'>"
				+	"		<span class='triggerText'>"	+ trigger.name + "</span>"
				+	"		<a data-trigger='"+ trigger.id + "' class='addIcon triggerIcon' href=''>"
				+	"			<i class='fa fa-plus-circle'></i>"
				+	"		</a>"
				+	"		<a data-trigger='" + trigger.id + "' class='editIcon triggerIcon' href=''>"
				+	"			<i class='fa fa-edit'></i>"
				+	"		</a>"
				+	"		<a data-trigger='" + trigger.id + "' class='deleteTriggerIcon triggerIcon' href=''>"
				+	"			<i class='fa fa-trash-o'></i>"
				+	"		</a>"
				+	"	</div>"
				+	"</div>");
		
		$('#triggerDiagram_' + trigger.id).data('trigger', trigger);
		$('#triggerDiagram_' + trigger.id).data('parent', parent);
		debugger;
		if(parent) {
			jsPlumbInstance.connect({
	            source:"triggerDiagram_" + parent.id,
	            target:"triggerDiagram_" + trigger.id,
	            connector: 'Flowchart',
	            anchor: "AutoDefault",
	            endpoint:"Blank",
	            detachable:false,
	            overlays:[["Arrow", {location: 1}]]
	        });
			
			jsPlumbInstance.draggable($('#triggerDiagram_' + trigger.id));
			$('#triggerDiagram_' + trigger.id).draggable({
		        stop: function(e){
		            if($(this).data('trigger')){
		            	var preferences = {};
		            	state = new Object();
		            	preferences.top = Math.round($(this).css('top').substring(0, $(this).css('top').length - 2));
		            	preferences.leftpx = Math.round($(this).css('left').substring(0, $(this).css('left').length - 2));
			            if(preferences.leftpx < 0) {
			            	preferences.leftpx = 0;
			            }
			            if(preferences.top < 0) {
			            	preferences.top = 0;
			            }
			            
			            saveState('triggerDiagram_' + $(this).data('trigger').id, preferences, false);
		            }
		        },
		        containment: 'parent'
		    });
		}
		
		top+= 50;
		$.each(trigger.childTriggers, function(idx, childTrigger) {
			left+=175;
			addTask(childTrigger, trigger, top, left, rootId, jsPlumbInstance);
		});
        
        
	}
</script>
<script src="${uiPath}/js/jquery.jsPlumb-1.7.5.min.js"></script>
