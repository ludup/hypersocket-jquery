
<div id="contentTemplates">
	<div class="modal" id="addTemplateForm" tabindex="-1" role="dialog" dialog-for="contentTemplates">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-hidden="true">&times;</button>
					<h4 class="modal-title"></h4>
				</div>
				<div class="modal-body">
					<div class="dialogError"></div>

					
					<div class="propertyItem form-group">
							<label class="col-xs-3 control-label" localize="template.type.label"></label>
							<div class="propertyValue col-xs-9">
								<div id="templateType"></div>
								<div>
									<span class="help-block" localize="template.type.info"></span>
								</div>
							</div>
						</div>
					<div id="templateProperties"></div>
					<div id="tabDetails" class="dialogTab">
						
					</div>
					<input type="hidden" id="templateId" name="templateId" value="" />
				</div>
				<div class="modal-footer"></div>
				</div>
			</div>
		</div>
	</div>
<div id="templateContent" class="panel panel-default">
	  <!-- Default panel contents -->
	  <div class="panel-heading">
	  	<h2><i class="fa fa-file-code-o"></i><span class="break" id="templateName"></span></h2>
	  </div>
	  <div class="panel-body">
		<div id="subjectContent" class="propertyItem form-group">
			<label class="col-xs-3 control-label" localize="template.subject.label"></label>
			<div class="propertyValue col-xs-9">
				<input type="text" class="form-control propertyInput"
					placeholder="" id="subject" maxlength="" name="subject" value="">
				<div>
					<span class="help-block" localize="template.subject.info"></span>
				</div>
			</div>
		</div>
		<textarea name="template" id="editor">This is some text.</textarea>
	  </div>
	  <div class="panel-footer">
	  	<button class="btn btn-primary" id="saveTemplate"><i class="fa fa-save"></i>&nbsp<span localize="text.save"></span></button>
	  </div>
	</div>
<script type="text/javascript">


	$(document).ready(function() {

		$('#templateContent').hide();
		$('#contentTemplates').localize();
		$('#templateContent').localize();
		
		if($('textarea#editor').tinymce()) {
			$('textarea#editor').tinymce().remove();	
		}
		
		tinymce.init({
		    selector: "textarea#editor",
			width:      '98%',
			height: '400px',
		    statusbar:  false,
		    menubar: true,
		    theme: "modern",
		    theme_advanced_resizing : true,
		    plugins: [
		        "advlist autolink lists link image charmap print preview hr anchor pagebreak",
		        "searchreplace wordcount visualblocks visualchars code fullscreen",
		        "insertdatetime media nonbreaking save table contextmenu directionality",
		        "emoticons template paste textcolor colorpicker textpattern"
		    ],
		    toolbar1: "insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image",
		    toolbar2: "print preview media | forecolor backcolor emoticons",
		    image_advtab: true,
		    setup : function(ed) {
                ed.on('change', function(e) {
		    		$('#saveTemplate').attr('disabled', false);
                });
		    }
		});
		
		
		$('#templateType').selectButton({
			id: 'type',
			url: 'templates/types',
			nameIsResourceKey: true,
			value: 'template.email',
			changed: function(scheme) {
				
			}
		});

		$('#templateProperties').propertyPage({
			url : 'templates/properties',
			showButtons : false,
			useTemplates : true,
			canUpdate : currentMenu.canUpdate,
			additionalTabs : [ {
				id : "tabDetails",
				name : getResource("template.label")
			}]
		});
		
		$('#contentTemplates').ajaxResourcePage(
				{
				title: getResource('templates.title'),
				icon: 'fa-file-code-o',
				tableUrl : "templates/table",
				resourceUrl : "templates/template",
				fields : [ { name: "name", isResourceKey: true }, { name: "type", isResourceKey: true}],
				resourceKey : 'template',
				canCreate: false,
				canUpdate: false,
				canDelete: false,
				validate : function() {
					if ($('#name').val() == '') {
						$('#addTemplateForm').resourceDialog('error',
								"error.nameRequired");
						return false;
					}

					return true;
				},
				clearDialog : function() {
					$('#name').val('');
					$('#type').val('template.email');
					$('#templateId').val('');
				},
				createResource : function() {
					app = new Object();
					app.id = $('#templateId').val();
					app.name = $('#name').val();
					app.type = $('#type').val();
					
					return app;
				},
				displayResource : function(resource) {
					$('#name').val(resource.name);
					$('#type').val(resource.type);
					$('#templateId').val(resource.id);
				},
				complete: function() {
					loadComplete();
				},
				selected: function(resource) {
					
					if($('#templateContent').data('resource') && !$('#saveTemplate').attr('disabled')) {
						
						bootbox.dialog({
							  message: getResource("template.notSaved.info"),
							  title: getResource("template.notSaved.title"),
							  buttons: {
							    success: {
							      label: getResource("text.yes"),
							      className: "btn-success",
							      callback: function() {
							    	  saveTemplate(function() {
											changeTemplate(resource);
										});
							      }
							    },
							    danger: {
							      label: getResource("text.no"),
							      className: "btn-danger",
							      callback: function() {
							        	changeTemplate(resource);
							      }
							    },
							    main: {
							      label: getResource("text.cancel"),
							      className: "btn-primary",
							      callback: function() {
							        
							      }
							    }
							  }
							});
					} else {
						changeTemplate(resource);
					}
				}
			});

		
	});
	
	$('#saveTemplate').click(function() {
		saveTemplate();
	});
	
	function saveTemplate(callback) {
		
		var resource = $('#templateContent').data('resource');
		resource.subject = $('#subject').val();
		resource.template = tinyMCE.activeEditor.getContent({format : 'raw'});
		
		postJSON('templates/template', resource, function(data) {
			if (data.success) {
				log("Template saved");
				showInformation(true, data.message);
				if(callback) {
					callback();
				}
				$('#saveTemplate').attr('disabled',true);
			} else {
				log("Resource object creation failed " + data.message);
				showError(false, data.message);
			}
		});
	}
	
	function changeTemplate(resource) {
		$('#saveTemplate').attr('disabled', 'disabled');
		if(resource.hasSubject) {
			$('#subjectContent').show();
			$('#subject').val(resource.subject);
		} else {	
			$('#subjectContent').hide();
			$('#subject').val('');
		}
		if(resource.nameIsResourceKey) {
			$('#templateName').text(getResource("template." + resource.name + ".label"));
		} else {
			$('#templateName').text(resource.name);
		}
		tinyMCE.activeEditor.setContent(resource.template);

		$('#templateContent').show();
		
		$('#editor').change(function() {
			$('#saveTemplate').attr('disabled', false);
		});
		
		$('#subject').change(function() {
			$('#saveTemplate').attr('disabled', false);
		});
		
		$('#templateContent').data('resource', resource);
	}
	</script>